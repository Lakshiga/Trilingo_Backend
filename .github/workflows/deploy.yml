name: Deploy .NET Backend to AWS EC2

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Detect backend directory
        id: backend-dir
        run: |
          echo "üîç Detecting backend directory structure..."
          if [ -d "Trilingo_Learning_App_Backend" ]; then
            echo "‚úÖ Found: Trilingo_Learning_App_Backend"
            echo "BACKEND_DIR=Trilingo_Learning_App_Backend" >> $GITHUB_OUTPUT
          elif [ -f "TES_Learning_App.API/TES_Learning_App.API.csproj" ]; then
            echo "‚úÖ Found: Root directory (TES_Learning_App.API)"
            echo "BACKEND_DIR=." >> $GITHUB_OUTPUT
          else
            echo "‚ùå Backend directory not found!"
            echo "üìÅ Current directory contents:"
            ls -la
            exit 1
          fi
          echo "üìÇ Using BACKEND_DIR: ${{ steps.backend-dir.outputs.BACKEND_DIR }}"

      - name: Restore dependencies
        run: dotnet restore
        working-directory: ${{ steps.backend-dir.outputs.BACKEND_DIR }}

      - name: Build application
        run: dotnet build --configuration Release --no-restore
        working-directory: ${{ steps.backend-dir.outputs.BACKEND_DIR }}

      - name: Publish application
        run: dotnet publish TES_Learning_App.API/TES_Learning_App.API.csproj --configuration Release --output ./TES_Learning_App.API/publish --no-build
        working-directory: ${{ steps.backend-dir.outputs.BACKEND_DIR }}

      - name: Create Systemd Service File
        run: |
          cat <<EOF > trilingo-backend.service
          [Unit]
          Description=Trilingo Learning App Backend API
          After=network.target

          [Service]
          Type=simple
          User=${{ secrets.EC2_USER }}
          WorkingDirectory=/var/www/trilingo-backend
          ExecStart=/usr/bin/dotnet /var/www/trilingo-backend/TES_Learning_App.API.dll
          Restart=always
          RestartSec=10
          KillSignal=SIGINT
          SyslogIdentifier=trilingo-backend
          Environment=ASPNETCORE_ENVIRONMENT=Production
          Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false
          Environment="ConnectionStrings__DefaultConnection=${{ secrets.DB_CONNECTION_STRING }}"

          [Install]
          WantedBy=multi-user.target
          EOF

      - name: Create deployment package
        run: |
          PUBLISH_DIR="${{ steps.backend-dir.outputs.BACKEND_DIR }}/TES_Learning_App.API/publish"
          PACKAGE_NAME="deployment-package.zip"
          echo "Creating zip package from $PUBLISH_DIR"
          cd "$PUBLISH_DIR"
          zip -r "${GITHUB_WORKSPACE}/${PACKAGE_NAME}" .
          cd "${GITHUB_WORKSPACE}"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>&1 || true

      - name: Test SSH Connection
        run: |
          echo "üîç Testing SSH connection to EC2..."
          MAX_RETRIES=3
          RETRY_DELAY=10
          CONNECTION_SUCCESS=false
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Connection test attempt $i of $MAX_RETRIES..."
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            if ssh -i ~/.ssh/id_rsa \
                   -o StrictHostKeyChecking=no \
                   -o ConnectTimeout=30 \
                   -o ServerAliveInterval=10 \
                   -o ServerAliveCountMax=3 \
                   -o UserKnownHostsFile=~/.ssh/known_hosts \
                   -o BatchMode=yes \
                   ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
                   "echo 'SSH connection successful'" 2>&1; then
              echo ""
              echo "‚úÖ SSH connection test successful!"
              CONNECTION_SUCCESS=true
              break
            else
              SSH_EXIT_CODE=$?
              echo ""
              echo "‚ùå SSH connection test failed (exit code: $SSH_EXIT_CODE)"
              
              if [ $i -lt $MAX_RETRIES ]; then
                echo "‚è≥ Retrying in $RETRY_DELAY seconds..."
                sleep $RETRY_DELAY
              fi
            fi
          done
          
          if [ "$CONNECTION_SUCCESS" = false ]; then
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚ùå CRITICAL: Cannot establish SSH connection"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
            echo "üî¥ The deployment cannot continue without SSH access!"
            echo ""
            echo "üìã TROUBLESHOOTING STEPS - AWS EC2 Configuration:"
            echo ""
            echo "1. ‚úÖ Verify EC2 Instance Status:"
            echo "   - Go to: https://console.aws.amazon.com/ec2/"
            echo "   - Navigate to: EC2 ‚Üí Instances"
            echo "   - Find your instance and verify status is 'running'"
            echo "   - If stopped, click 'Start instance'"
            echo ""
            echo "2. ‚úÖ Verify Security Group Rules:"
            echo "   - Select your EC2 instance"
            echo "   - Click 'Security' tab (bottom panel)"
            echo "   - Click on Security Group ID (e.g., 'sg-xxxxx')"
            echo "   - Click 'Edit inbound rules'"
            echo "   - Ensure you have this rule:"
            echo "     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
            echo "     ‚îÇ Type:        SSH                       ‚îÇ"
            echo "     ‚îÇ Protocol:    TCP                       ‚îÇ"
            echo "     ‚îÇ Port range:  22                         ‚îÇ"
            echo "     ‚îÇ Source:      0.0.0.0/0                  ‚îÇ"
            echo "     ‚îÇ Description: Allow SSH from GitHub      ‚îÇ"
            echo "     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
            echo "   - If rule doesn't exist, click 'Add rule' and create it"
            echo "   - Click 'Save rules'"
            echo ""
            echo "3. ‚úÖ Verify EC2_HOST Secret:"
            echo "   - Go to: GitHub ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   - Check EC2_HOST secret value"
            echo "   - It should match your EC2 instance's:"
            echo "     ‚Ä¢ Public IPv4 address (e.g., 54.123.45.67)"
            echo "     ‚Ä¢ OR Public IPv4 DNS (e.g., ec2-54-123-45-67.compute-1.amazonaws.com)"
            echo "   - Get the correct value from: EC2 Console ‚Üí Instances ‚Üí Your instance ‚Üí Details tab"
            echo ""
            echo "4. ‚úÖ Test SSH Manually (from your local machine):"
            echo "   ssh -i your-key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}"
            echo "   If this works, GitHub Actions should also work"
            echo ""
            echo "5. ‚úÖ Check EC2 Instance Public IP:"
            echo "   - EC2 instances get new Public IPs when stopped/started"
            echo "   - If you restarted the instance, update EC2_HOST secret with new IP"
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
            exit 1
          fi

      - name: Copy files to EC2
        run: |
          echo "üì¶ Copying deployment files to EC2..."
          MAX_RETRIES=3
          RETRY_DELAY=10
          
          # Function to copy file with retry
          copy_with_retry() {
            local file=$1
            local dest=$2
            local attempt=1
            
            while [ $attempt -le $MAX_RETRIES ]; do
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "Copying $file (attempt $attempt of $MAX_RETRIES)..."
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              
              if scp -i ~/.ssh/id_rsa \
                     -o StrictHostKeyChecking=no \
                     -o ConnectTimeout=30 \
                     -o ServerAliveInterval=10 \
                     -o ServerAliveCountMax=3 \
                     -o UserKnownHostsFile=~/.ssh/known_hosts \
                     "$file" "$dest" 2>&1; then
                echo ""
                echo "‚úÖ Successfully copied $file"
                return 0
              else
                echo ""
                echo "‚ùå Copy attempt $attempt failed"
                
                if [ $attempt -lt $MAX_RETRIES ]; then
                  echo "‚è≥ Retrying in $RETRY_DELAY seconds..."
                  sleep $RETRY_DELAY
                  attempt=$((attempt + 1))
                else
                  echo ""
                  echo "‚ùå Failed to copy $file after $MAX_RETRIES attempts"
                  return 1
                fi
              fi
            done
          }
          
          # Copy deployment package
          if ! copy_with_retry "deployment-package.zip" "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/"; then
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚ùå CRITICAL: Failed to copy deployment package"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
            echo "The SSH connection test passed, but file copy is failing."
            echo "This might indicate:"
            echo "  - Network instability"
            echo "  - File size too large"
            echo "  - EC2 instance under heavy load"
            echo ""
            echo "üí° Try:"
            echo "  - Re-run this workflow (may work on retry)"
            echo "  - Check EC2 instance status in AWS Console"
            echo "  - Verify instance has enough disk space"
            echo ""
            exit 1
          fi
          
          # Copy service file
          if ! copy_with_retry "trilingo-backend.service" "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/"; then
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚ùå CRITICAL: Failed to copy service file"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
            echo "The deployment package was copied, but service file copy failed."
            echo "This is unusual - please check EC2 instance status."
            echo ""
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All files copied successfully!"

      - name: Deploy to EC2
        run: |
          echo "üöÄ Starting deployment to EC2..."
          MAX_RETRIES=3
          RETRY_DELAY=10
          
          # Function to deploy with retry
          deploy_with_retry() {
            local attempt=1
            
            while [ $attempt -le $MAX_RETRIES ]; do
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "Deployment attempt $attempt of $MAX_RETRIES..."
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              
              if ssh -i ~/.ssh/id_rsa \
                     -o StrictHostKeyChecking=no \
                     -o ConnectTimeout=30 \
                     -o ServerAliveInterval=10 \
                     -o ServerAliveCountMax=3 \
                     -o UserKnownHostsFile=~/.ssh/known_hosts \
                     -o BatchMode=yes \
                     ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
                     "set -e && \
                      APP_DIR=\"/var/www/trilingo-backend\" && \
                      BACKUP_DIR=\"/var/www/trilingo-backend-backup\" && \
                      SERVICE_NAME=\"trilingo-backend\" && \
                      EC2_USER=\"${{ secrets.EC2_USER }}\" && \
                      echo \"üöÄ Starting deployment...\" && \
                      sudo mkdir -p \$APP_DIR && \
                      sudo mkdir -p \$BACKUP_DIR && \
                      if sudo systemctl is-active --quiet \$SERVICE_NAME; then \
                        echo \"‚è∏Ô∏è  Stopping service...\" && \
                        sudo systemctl stop \$SERVICE_NAME || true; \
                      fi && \
                      if [ -d \"\$APP_DIR\" ] && [ \"\$(ls -A \$APP_DIR)\" ]; then \
                        echo \"üíæ Creating backup...\" && \
                        sudo cp -r \$APP_DIR/* \$BACKUP_DIR/\$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true; \
                      fi && \
                      echo \"üì¶ Extracting package...\" && \
                      TEMP_DIR=\$(mktemp -d) && \
                      sudo unzip -q /tmp/deployment-package.zip -d \$TEMP_DIR && \
                      if [ -d \"\$APP_DIR/wwwroot\" ]; then \
                        echo \"  - Preserving wwwroot...\" && \
                        sudo mkdir -p \$TEMP_DIR/wwwroot && \
                        sudo cp -r \$APP_DIR/wwwroot/* \$TEMP_DIR/wwwroot/ 2>/dev/null || true; \
                      fi && \
                      echo \"üßπ Updating files...\" && \
                      sudo rm -rf \$APP_DIR/* && \
                      sudo cp -r \$TEMP_DIR/* \$APP_DIR/ && \
                      echo \"üìù Updating Systemd Service...\" && \
                      sudo mv /tmp/trilingo-backend.service /etc/systemd/system/\$SERVICE_NAME.service && \
                      echo \"üîê Setting permissions...\" && \
                      sudo chown -R \$EC2_USER:\$EC2_USER \$APP_DIR && \
                      sudo chmod +x \$APP_DIR/TES_Learning_App.API.dll || true && \
                      echo \"üîÑ Restarting service...\" && \
                      sudo systemctl daemon-reload && \
                      sudo systemctl enable \$SERVICE_NAME && \
                      sudo systemctl start \$SERVICE_NAME && \
                      sudo rm -rf \$TEMP_DIR && \
                      sudo rm -f /tmp/deployment-package.zip && \
                      echo \"‚è≥ Waiting for service to initialize...\" && \
                      sleep 5 && \
                      if sudo systemctl is-active --quiet \$SERVICE_NAME; then \
                        echo \"‚úÖ Service started successfully!\" && \
                        sudo systemctl status \$SERVICE_NAME --no-pager -l; \
                      else \
                        echo \"‚ùå Service failed to start. Showing logs:\" && \
                        sudo journalctl -u \$SERVICE_NAME --no-pager -n 50 && \
                        exit 1; \
                      fi" 2>&1; then
                echo ""
                echo "‚úÖ Deployment completed successfully!"
                return 0
              else
                SSH_EXIT_CODE=$?
                echo ""
                echo "‚ùå Deployment attempt $attempt failed (exit code: $SSH_EXIT_CODE)"
                
                if [ $attempt -lt $MAX_RETRIES ]; then
                  echo "‚è≥ Retrying in $RETRY_DELAY seconds..."
                  sleep $RETRY_DELAY
                  attempt=$((attempt + 1))
                else
                  echo ""
                  echo "‚ùå Deployment failed after $MAX_RETRIES attempts"
                  return 1
                fi
              fi
            done
          }
          
          # Execute deployment with retry
          if deploy_with_retry; then
            echo ""
            echo "‚úÖ Deployment process completed!"
          else
            echo ""
            echo "‚ùå Deployment failed after all retry attempts"
            exit 1
          fi

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_rsa
