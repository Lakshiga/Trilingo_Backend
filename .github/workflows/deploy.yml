name: Deploy .NET Backend to AWS EC2

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Detect backend directory
        id: backend-dir
        run: |
          if [ -d "Trilingo_Learning_App_Backend" ]; then
            echo "BACKEND_DIR=Trilingo_Learning_App_Backend" >> $GITHUB_OUTPUT
          elif [ -f "TES_Learning_App.API/TES_Learning_App.API.csproj" ]; then
            echo "BACKEND_DIR=." >> $GITHUB_OUTPUT
          else
            echo "‚ùå Backend directory not found!"
            exit 1
          fi

      - name: Restore dependencies
        run: dotnet restore
        working-directory: ${{ steps.backend-dir.outputs.BACKEND_DIR }}

      - name: Build application
        run: dotnet build --configuration Release --no-restore
        working-directory: ${{ steps.backend-dir.outputs.BACKEND_DIR }}

      - name: Publish application
        run: dotnet publish TES_Learning_App.API/TES_Learning_App.API.csproj --configuration Release --output ./TES_Learning_App.API/publish --no-build
        working-directory: ${{ steps.backend-dir.outputs.BACKEND_DIR }}

      # ---------------------------------------------------------
      # FIX APPLIED: Changed Type=notify to Type=simple
      # This prevents the "Core Dump" / Timeout error.
      # ---------------------------------------------------------
      - name: Create Systemd Service File
        run: |
          cat <<EOF > trilingo-backend.service
          [Unit]
          Description=Trilingo Learning App Backend API
          After=network.target

          [Service]
          Type=simple
          User=${{ secrets.EC2_USER }}
          WorkingDirectory=/var/www/trilingo-backend
          ExecStart=/usr/bin/dotnet /var/www/trilingo-backend/TES_Learning_App.API.dll
          Restart=always
          RestartSec=10
          KillSignal=SIGINT
          SyslogIdentifier=trilingo-backend
          Environment=ASPNETCORE_ENVIRONMENT=Production
          Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false
          Environment="ConnectionStrings__DefaultConnection=${{ secrets.DB_CONNECTION_STRING }}"

          [Install]
          WantedBy=multi-user.target
          EOF

      - name: Create deployment package
        run: |
          PUBLISH_DIR="${{ steps.backend-dir.outputs.BACKEND_DIR }}/TES_Learning_App.API/publish"
          PACKAGE_NAME="deployment-package.zip"
          echo "Creating zip package from $PUBLISH_DIR"
          cd "$PUBLISH_DIR"
          zip -r "${GITHUB_WORKSPACE}/${PACKAGE_NAME}" .
          cd "${GITHUB_WORKSPACE}"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Validate secrets are set
          if [ -z "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå Error: EC2_SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "‚ùå Error: EC2_HOST secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.EC2_USER }}" ]; then
            echo "‚ùå Error: EC2_USER secret is not set"
            exit 1
          fi
          
          # Write SSH private key
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Verify SSH key format
          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "‚ùå Error: SSH private key file is empty"
            exit 1
          fi
          
          # Check if key starts with proper header
          if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/id_rsa; then
            echo "‚ùå Error: SSH private key format is invalid (missing BEGIN header)"
            exit 1
          fi
          
          # Add host to known_hosts (non-fatal, but log if it fails)
          echo "üîç Scanning host keys for ${{ secrets.EC2_HOST }}..."
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ö†Ô∏è  Warning: Could not scan host keys (this is usually OK if host is not reachable yet)"
            echo "   Will use StrictHostKeyChecking=no in SSH commands"
          }
          
          echo "‚úÖ SSH configuration completed"

      - name: Verify EC2 Configuration
        run: |
          echo "üîç Verifying EC2 configuration..."
          
          # Check if secrets are set
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "‚ùå Error: EC2_HOST secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.EC2_USER }}" ]; then
            echo "‚ùå Error: EC2_USER secret is not set"
            exit 1
          fi
          
          # Display configuration (masked)
          echo "‚úÖ EC2_HOST is set: ${EC2_HOST:0:3}***"
          echo "‚úÖ EC2_USER is set: ${{ secrets.EC2_USER }}"
          
          # Verify host format
          EC2_HOST="${{ secrets.EC2_HOST }}"
          if [[ ! "$EC2_HOST" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]] && [[ ! "$EC2_HOST" =~ ^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
            echo "‚ö†Ô∏è  Warning: EC2_HOST format might be invalid: $EC2_HOST"
            echo "   Expected: IP address (e.g., 1.2.3.4) or domain name (e.g., ec2-1-2-3-4.compute-1.amazonaws.com)"
          fi
          
          echo "‚úÖ Configuration verified"

      - name: Test Network Connectivity
        run: |
          echo "üåê Testing network connectivity to EC2..."
          EC2_HOST="${{ secrets.EC2_HOST }}"
          
          # Test if host is reachable (ping with timeout)
          echo "Testing ping to $EC2_HOST..."
          if timeout 5 ping -c 3 "$EC2_HOST" 2>&1 || timeout 5 ping -c 3 "$EC2_HOST" 2>&1; then
            echo "‚úÖ Host is reachable via ping"
          else
            echo "‚ö†Ô∏è  Warning: Host might not be reachable via ping (this is normal for some EC2 instances)"
            echo "   Continuing with SSH test..."
          fi
          
          # Test port 22 connectivity
          echo "Testing port 22 connectivity..."
          if timeout 5 bash -c "echo > /dev/tcp/$EC2_HOST/22" 2>/dev/null; then
            echo "‚úÖ Port 22 is open"
          else
            echo "‚ö†Ô∏è  Warning: Cannot connect to port 22"
            echo "   This might indicate:"
            echo "   - Security group doesn't allow SSH from GitHub Actions"
            echo "   - EC2 instance is not running"
            echo "   - Network connectivity issues"
          fi

      - name: Test SSH Connection
        continue-on-error: true
        run: |
          echo "üîç Testing SSH connection to EC2..."
          MAX_RETRIES=2
          RETRY_DELAY=10
          CONNECT_TIMEOUT=15
          
          CONNECTION_SUCCESS=false
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Attempt $i of $MAX_RETRIES..."
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            if ssh -i ~/.ssh/id_rsa \
                   -o StrictHostKeyChecking=no \
                   -o ConnectTimeout=$CONNECT_TIMEOUT \
                   -o ServerAliveInterval=10 \
                   -o ServerAliveCountMax=3 \
                   -o UserKnownHostsFile=~/.ssh/known_hosts \
                   -o BatchMode=yes \
                   -o LogLevel=ERROR \
                   ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
                   "echo 'Connection successful'" 2>&1; then
              echo ""
              echo "‚úÖ SSH connection successful!"
              CONNECTION_SUCCESS=true
              break
            else
              SSH_EXIT_CODE=$?
              echo ""
              echo "‚ùå SSH connection failed (exit code: $SSH_EXIT_CODE)"
              
              if [ $i -lt $MAX_RETRIES ]; then
                echo "‚è≥ Retrying in $RETRY_DELAY seconds..."
                sleep $RETRY_DELAY
              fi
            fi
          done
          
          if [ "$CONNECTION_SUCCESS" = false ]; then
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚ö†Ô∏è  WARNING: SSH connection test failed"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
            echo "üî¥ CRITICAL: You MUST fix the Security Group before deployment will work!"
            echo ""
            echo "üìã EXACT STEPS TO FIX:"
            echo ""
            echo "1. Go to AWS Console ‚Üí EC2 ‚Üí Instances"
            echo "2. Select your EC2 instance"
            echo "3. Click on the 'Security' tab"
            echo "4. Click on the Security Group link (e.g., 'sg-xxxxx')"
            echo "5. Click 'Edit inbound rules'"
            echo "6. Click 'Add rule'"
            echo "7. Configure the rule:"
            echo "   - Type: SSH"
            echo "   - Protocol: TCP"
            echo "   - Port range: 22"
            echo "   - Source: 0.0.0.0/0 (for testing) or specific IP"
            echo "   - Description: Allow SSH from GitHub Actions"
            echo "8. Click 'Save rules'"
            echo ""
            echo "‚ö†Ô∏è  Note: The deployment will continue but will likely fail at the next step"
            echo "   if the security group is not configured correctly."
            echo ""
            echo "üîç Additional Checks:"
            echo "   - Verify EC2 instance is 'running'"
            echo "   - Verify EC2_HOST secret matches instance Public IP/DNS"
            echo "   - Test SSH manually: ssh -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}"
            echo ""
          fi

      - name: Copy files to EC2
        run: |
          echo "üì¶ Copying deployment files to EC2..."
          echo ""
          echo "‚ö†Ô∏è  If this step fails with 'Connection timed out', check:"
          echo "   1. EC2 Security Group allows SSH (port 22) from 0.0.0.0/0"
          echo "   2. EC2 instance is running"
          echo "   3. EC2_HOST secret is correct"
          echo ""
          MAX_RETRIES=3
          RETRY_DELAY=5
          
          # Function to copy file with retry
          copy_with_retry() {
            local file=$1
            local dest=$2
            local attempt=1
            
            while [ $attempt -le $MAX_RETRIES ]; do
              echo "Copying $file (attempt $attempt of $MAX_RETRIES)..."
              if scp -i ~/.ssh/id_rsa \
                     -o StrictHostKeyChecking=no \
                     -o ConnectTimeout=30 \
                     -o ServerAliveInterval=60 \
                     -o ServerAliveCountMax=3 \
                     -o UserKnownHostsFile=~/.ssh/known_hosts \
                     "$file" "$dest" 2>&1; then
                echo "‚úÖ Successfully copied $file"
                return 0
              else
                if [ $attempt -lt $MAX_RETRIES ]; then
                  echo "‚è≥ Copy failed. Retrying in $RETRY_DELAY seconds..."
                  sleep $RETRY_DELAY
                  attempt=$((attempt + 1))
                else
                  echo "‚ùå Failed to copy $file after $MAX_RETRIES attempts"
                  return 1
                fi
              fi
            done
          }
          
          # Copy deployment package
          copy_with_retry "deployment-package.zip" "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/" || exit 1
          
          # Copy service file
          copy_with_retry "trilingo-backend.service" "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/" || exit 1
          
          echo "‚úÖ All files copied successfully!"

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              -o ServerAliveInterval=60 \
              -o ServerAliveCountMax=3 \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            
            # Configuration
            APP_DIR="/var/www/trilingo-backend"
            BACKUP_DIR="/var/www/trilingo-backend-backup"
            SERVICE_NAME="trilingo-backend"
            
            echo "üöÄ Starting deployment..."
            
            # 1. Create directories
            sudo mkdir -p $APP_DIR
            sudo mkdir -p $BACKUP_DIR
            
            # 2. Stop service
            if sudo systemctl is-active --quiet $SERVICE_NAME; then
              echo "‚è∏Ô∏è  Stopping service..."
              sudo systemctl stop $SERVICE_NAME || true
            fi
            
            # 3. Backup
            if [ -d "$APP_DIR" ] && [ "$(ls -A $APP_DIR)" ]; then
              echo "üíæ Creating backup..."
              sudo cp -r $APP_DIR/* $BACKUP_DIR/$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true
            fi
            
            # 4. Extract New Files
            echo "üì¶ Extracting package..."
            TEMP_DIR=$(mktemp -d)
            sudo unzip -q /tmp/deployment-package.zip -d $TEMP_DIR
            
            # 5. Preserve specific files (wwwroot/uploads)
            if [ -d "$APP_DIR/wwwroot" ]; then
              echo "  - Preserving wwwroot..."
              sudo mkdir -p $TEMP_DIR/wwwroot
              sudo cp -r $APP_DIR/wwwroot/* $TEMP_DIR/wwwroot/ 2>/dev/null || true
            fi

            # 6. Move files to App Dir
            echo "üßπ Updating files..."
            sudo rm -rf $APP_DIR/*
            sudo cp -r $TEMP_DIR/* $APP_DIR/
            
            # 7. Install/Update Service File
            echo "üìù Updating Systemd Service..."
            sudo mv /tmp/trilingo-backend.service /etc/systemd/system/$SERVICE_NAME.service
            
            # 8. Permissions
            echo "üîê Setting permissions..."
            sudo chown -R ${{ secrets.EC2_USER }}:${{ secrets.EC2_USER }} $APP_DIR
            sudo chmod +x $APP_DIR/TES_Learning_App.API.dll || true
            
            # 9. Restart Service
            echo "üîÑ Restarting service..."
            sudo systemctl daemon-reload
            sudo systemctl enable $SERVICE_NAME
            sudo systemctl start $SERVICE_NAME
            
            # 10. Cleanup
            sudo rm -rf $TEMP_DIR
            sudo rm -f /tmp/deployment-package.zip
            
            # 11. Check Status
            echo "‚è≥ Waiting for service to initialize..."
            sleep 5
            
            if sudo systemctl is-active --quiet $SERVICE_NAME; then
              echo "‚úÖ Service started successfully!"
              sudo systemctl status $SERVICE_NAME --no-pager -l
            else
              echo "‚ùå Service failed to start. Showing logs:"
              sudo journalctl -u $SERVICE_NAME --no-pager -n 50
              exit 1
            fi
          ENDSSH
      
      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_rsa