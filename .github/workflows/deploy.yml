name: Deploy .NET Backend to AWS EC2

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Detect backend directory
        id: backend-dir
        run: |
          if [ -d "Trilingo_Learning_App_Backend" ]; then
            echo "BACKEND_DIR=Trilingo_Learning_App_Backend" >> $GITHUB_OUTPUT
          elif [ -f "TES_Learning_App.API/TES_Learning_App.API.csproj" ]; then
            echo "BACKEND_DIR=." >> $GITHUB_OUTPUT
          else
            echo "âŒ Backend directory not found!"
            exit 1
          fi
      - name: Restore dependencies
        run: dotnet restore
        working-directory: ${{ steps.backend-dir.outputs.BACKEND_DIR }}

      - name: Build application
        run: dotnet build --configuration Release --no-restore
        working-directory: ${{ steps.backend-dir.outputs.BACKEND_DIR }}

      - name: Publish application
        run: dotnet publish TES_Learning_App.API/TES_Learning_App.API.csproj --configuration Release --output ./TES_Learning_App.API/publish --no-build
        working-directory: ${{ steps.backend-dir.outputs.BACKEND_DIR }}

      - name: Create deployment package
        run: |
          PUBLISH_DIR="${{ steps.backend-dir.outputs.BACKEND_DIR }}/TES_Learning_App.API/publish"
          PACKAGE_NAME="deployment-package.zip"
          echo "Creating zip package from $PUBLISH_DIR"
          cd "$PUBLISH_DIR"
          zip -r "${GITHUB_WORKSPACE}/${PACKAGE_NAME}" .
          cd "${GITHUB_WORKSPACE}"
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      - name: Copy deployment package to EC2
        run: |
          scp -i ~/.ssh/id_rsa deployment-package.zip ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/
      - name: Deploy to EC2 (Preserve Existing Files)
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            
            # Configuration
            APP_DIR="/var/www/trilingo-backend"
            BACKUP_DIR="/var/www/trilingo-backend-backup"
            SERVICE_NAME="trilingo-backend"
            
            echo "ðŸš€ Starting deployment..."
            
            # Create app directory if it doesn't exist
            sudo mkdir -p $APP_DIR
            
            # Create backup directory
            sudo mkdir -p $BACKUP_DIR
            
            # Stop the service if it's running
            if sudo systemctl is-active --quiet $SERVICE_NAME; then
              echo "â¸ï¸  Stopping service..."
              sudo systemctl stop $SERVICE_NAME || true
            fi
            
            # Backup existing application (excluding data directories)
            if [ -d "$APP_DIR" ] && [ "$(ls -A $APP_DIR)" ]; then
              echo "ðŸ’¾ Creating backup..."
              sudo mkdir -p $BACKUP_DIR/$(date +%Y%m%d_%H%M%S)
              sudo cp -r $APP_DIR/* $BACKUP_DIR/$(date +%Y%m%d_%H%M%S)/ || true
            fi
            
            # Extract new deployment package to temporary location
            echo "ðŸ“¦ Extracting deployment package..."
            TEMP_DIR=$(mktemp -d)
            sudo unzip -q /tmp/deployment-package.zip -d $TEMP_DIR
            
            # Preserve critical files and directories
            echo "ðŸ”’ Preserving existing files..."
            
            # Preserve wwwroot/uploads directory (user uploads)
            if [ -d "$APP_DIR/wwwroot" ]; then
              echo "  - Preserving wwwroot/uploads..."
              sudo mkdir -p $TEMP_DIR/wwwroot
              sudo cp -r $APP_DIR/wwwroot/* $TEMP_DIR/wwwroot/ 2>/dev/null || true
            fi
            
            # Preserve appsettings.Aws.json (AWS configuration)
            if [ -f "$APP_DIR/appsettings.Aws.json" ]; then
              echo "  - Preserving appsettings.Aws.json..."
              sudo cp $APP_DIR/appsettings.Aws.json $TEMP_DIR/appsettings.Aws.json
            fi
            
            # Preserve any custom configuration files
            if [ -f "$APP_DIR/appsettings.Production.json" ]; then
              echo "  - Preserving appsettings.Production.json..."
              sudo cp $APP_DIR/appsettings.Production.json $TEMP_DIR/appsettings.Production.json
            fi
            
            # Remove old application files (except preserved directories)
            echo "ðŸ§¹ Cleaning old files..."
            sudo find $APP_DIR -mindepth 1 -maxdepth 1 ! -name "wwwroot" -exec rm -rf {} + || true
            
            # Copy new files to application directory
            echo "ðŸ“‹ Copying new files..."
            sudo cp -r $TEMP_DIR/* $APP_DIR/
            
            # Set proper permissions
            echo "ðŸ” Setting permissions..."
            sudo chown -R ${{ secrets.EC2_USER }}:${{ secrets.EC2_USER }} $APP_DIR
            sudo chmod +x $APP_DIR/TES_Learning_App.API || true
            
            # Cleanup temporary directory
            sudo rm -rf $TEMP_DIR
            sudo rm -f /tmp/deployment-package.zip
            
            # Restart the service
            echo "ðŸ”„ Restarting service..."
            
            # Create systemd service file if it doesn't exist
            if [ ! -f "/etc/systemd/system/$SERVICE_NAME.service" ]; then
              echo "ðŸ“ Creating systemd service..."
              sudo tee /etc/systemd/system/$SERVICE_NAME.service > /dev/null <<'EOF'
                [Unit]
                Description=Trilingo Learning App Backend API
                After=network.target

                [Service]
                Type=notify
                User=${{ secrets.EC2_USER }}
                WorkingDirectory=$APP_DIR
                ExecStart=/usr/bin/dotnet $APP_DIR/TES_Learning_App.API.dll
                Restart=always
                RestartSec=10
                KillSignal=SIGINT
                SyslogIdentifier=trilingo-backend
                Environment=ASPNETCORE_ENVIRONMENT=Production
                Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false

              [Install]
              WantedBy=multi-user.target
              SERVICE_EOF
              sudo sed -i 's/^[[:space:]]*//' /etc/systemd/system/$SERVICE_NAME.service
              sudo systemctl daemon-reload
              sudo systemctl enable $SERVICE_NAME
            fi
            
            # Start the service
            sudo systemctl start $SERVICE_NAME
            sudo systemctl daemon-reload
            
            # Wait a moment and check service status
            sleep 3
            if sudo systemctl is-active --quiet $SERVICE_NAME; then
              echo "âœ… Service started successfully!"
              sudo systemctl status $SERVICE_NAME --no-pager -l
            else
              echo "âŒ Service failed to start. Checking logs..."
              sudo journalctl -u $SERVICE_NAME --no-pager -l -n 50
              exit 1
            fi
            
            echo "ðŸŽ‰ Deployment completed successfully!"
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 5
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            SERVICE_NAME="trilingo-backend"
            if sudo systemctl is-active --quiet $SERVICE_NAME; then
              echo "âœ… Backend service is running"
              sudo systemctl status $SERVICE_NAME --no-pager -l | head -20
            else
              echo "âŒ Backend service is not running"
              exit 1
            fi
          ENDSSH
      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_rsa