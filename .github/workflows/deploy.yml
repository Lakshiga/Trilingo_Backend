name: Deploy .NET Backend to AWS EC2

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Detect backend directory
        id: backend-dir
        run: |
          if [ -d "Trilingo_Learning_App_Backend" ]; then
            echo "BACKEND_DIR=Trilingo_Learning_App_Backend" >> $GITHUB_OUTPUT
          elif [ -f "TES_Learning_App.API/TES_Learning_App.API.csproj" ]; then
            echo "BACKEND_DIR=." >> $GITHUB_OUTPUT
          else
            echo "‚ùå Backend directory not found!"
            exit 1
          fi
      - name: Restore dependencies
        run: dotnet restore
        working-directory: ${{ steps.backend-dir.outputs.BACKEND_DIR }}

      - name: Build application
        run: dotnet build --configuration Release --no-restore
        working-directory: ${{ steps.backend-dir.outputs.BACKEND_DIR }}

      - name: Publish application
        run: dotnet publish TES_Learning_App.API/TES_Learning_App.API.csproj --configuration Release --output ./TES_Learning_App.API/publish --no-build
        working-directory: ${{ steps.backend-dir.outputs.BACKEND_DIR }}

      # ---------------------------------------------------------
      # FIX APPLIED: Changed Type=notify to Type=simple
      # This prevents the "Core Dump" / Timeout error.
      # ---------------------------------------------------------
      - name: Create Systemd Service File
        run: |
          cat <<EOF > trilingo-backend.service
          [Unit]
          Description=Trilingo Learning App Backend API
          After=network.target
          [Service]
          Type=simple
          User=${{ secrets.EC2_USER }}
          WorkingDirectory=/var/www/trilingo-backend
          ExecStart=/usr/bin/dotnet /var/www/trilingo-backend/TES_Learning_App.API.dll
          Restart=always
          RestartSec=10
          KillSignal=SIGINT
          SyslogIdentifier=trilingo-backend
          Environment=ASPNETCORE_ENVIRONMENT=Production
          Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false
          Environment="ConnectionStrings__DefaultConnection=${{ secrets.DB_CONNECTION_STRING }}"
          [Install]
          WantedBy=multi-user.target
          EOF
      - name: Create deployment package
        run: |
          PUBLISH_DIR="${{ steps.backend-dir.outputs.BACKEND_DIR }}/TES_Learning_App.API/publish"
          PACKAGE_NAME="deployment-package.zip"
          echo "Creating zip package from $PUBLISH_DIR"
          cd "$PUBLISH_DIR"
          zip -r "${GITHUB_WORKSPACE}/${PACKAGE_NAME}" .
          cd "${GITHUB_WORKSPACE}"
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write SSH key with proper formatting (remove Windows line endings)
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Validate SSH key format
          echo "üîç Validating SSH key format..."
          if ! ssh-keygen -l -f ~/.ssh/id_rsa > /dev/null 2>&1; then
            echo "‚ùå Error: SSH key format is invalid or corrupted"
            echo ""
            echo "üìã HOW TO FIX:"
            echo "   1. Open your backend-key.pem file in a text editor"
            echo "   2. Select ALL content (Ctrl+A)"
            echo "   3. Copy it (Ctrl+C)"
            echo "   4. Go to GitHub ‚Üí Settings ‚Üí Secrets ‚Üí Actions"
            echo "   5. Edit EC2_SSH_PRIVATE_KEY secret"
            echo "   6. Paste the ENTIRE key content (including BEGIN/END lines)"
            echo "   7. Make sure there are NO extra spaces before/after"
            echo "   8. Save the secret"
            exit 1
          fi
          
          echo "‚úÖ SSH key format is valid"
          
          # Add host to known_hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>&1 || true
          echo "‚úÖ SSH configuration completed"

      - name: Copy files to EC2
        run: |
          echo "üì¶ Copying deployment files to EC2..."
          MAX_RETRIES=3
          RETRY_DELAY=10
          
          # Function to copy file with retry
          copy_with_retry() {
            local file=$1
            local dest=$2
            local attempt=1
            
            while [ $attempt -le $MAX_RETRIES ]; do
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "Copying $file (attempt $attempt of $MAX_RETRIES)..."
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              
              if scp -i ~/.ssh/id_rsa \
                     -o StrictHostKeyChecking=no \
                     -o ConnectTimeout=30 \
                     -o ServerAliveInterval=10 \
                     -o ServerAliveCountMax=3 \
                     -o UserKnownHostsFile=~/.ssh/known_hosts \
                     "$file" "$dest" 2>&1; then
                echo ""
                echo "‚úÖ Successfully copied $file"
                return 0
              else
                echo ""
                echo "‚ùå Copy attempt $attempt failed"
                
                if [ $attempt -lt $MAX_RETRIES ]; then
                  echo "‚è≥ Retrying in $RETRY_DELAY seconds..."
                  sleep $RETRY_DELAY
                  attempt=$((attempt + 1))
                else
                  echo ""
                  echo "‚ùå Failed to copy $file after $MAX_RETRIES attempts"
                  return 1
                fi
              fi
            done
          }
          
          # Copy deployment package
          if ! copy_with_retry "deployment-package.zip" "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/"; then
            echo ""
            echo "‚ùå Deployment aborted: Cannot copy deployment package"
            exit 1
          fi
          
          # Copy service file
          if ! copy_with_retry "trilingo-backend.service" "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/"; then
            echo ""
            echo "‚ùå Deployment aborted: Cannot copy service file"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All files copied successfully!"
      - name: Deploy to EC2
        run: |
          echo "üöÄ Starting deployment to EC2..."
          ssh -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              -o ServerAliveInterval=10 \
              -o ServerAliveCountMax=3 \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o BatchMode=yes \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              "set -e && \
               APP_DIR=\"/var/www/trilingo-backend\" && \
               BACKUP_DIR=\"/var/www/trilingo-backend-backup\" && \
               SERVICE_NAME=\"trilingo-backend\" && \
               EC2_USER=\"${{ secrets.EC2_USER }}\" && \
               echo \"üöÄ Starting deployment...\" && \
               sudo mkdir -p \$APP_DIR && \
               sudo mkdir -p \$BACKUP_DIR && \
               if sudo systemctl is-active --quiet \$SERVICE_NAME; then \
                 echo \"‚è∏Ô∏è  Stopping service...\" && \
                 sudo systemctl stop \$SERVICE_NAME || true; \
               fi && \
               if [ -d \"\$APP_DIR\" ] && [ \"\$(ls -A \$APP_DIR)\" ]; then \
                 echo \"üíæ Creating backup...\" && \
                 sudo cp -r \$APP_DIR/* \$BACKUP_DIR/\$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true; \
               fi && \
               echo \"üì¶ Extracting package...\" && \
               TEMP_DIR=\$(mktemp -d) && \
               sudo unzip -q /tmp/deployment-package.zip -d \$TEMP_DIR && \
               if [ -d \"\$APP_DIR/wwwroot\" ]; then \
                 echo \"  - Preserving wwwroot...\" && \
                 sudo mkdir -p \$TEMP_DIR/wwwroot && \
                 sudo cp -r \$APP_DIR/wwwroot/* \$TEMP_DIR/wwwroot/ 2>/dev/null || true; \
               fi && \
               echo \"üßπ Updating files...\" && \
               sudo rm -rf \$APP_DIR/* && \
               sudo cp -r \$TEMP_DIR/* \$APP_DIR/ && \
               echo \"üìù Updating Systemd Service...\" && \
               sudo mv /tmp/trilingo-backend.service /etc/systemd/system/\$SERVICE_NAME.service && \
               echo \"üîê Setting permissions...\" && \
               sudo chown -R \$EC2_USER:\$EC2_USER \$APP_DIR && \
               sudo chmod +x \$APP_DIR/TES_Learning_App.API.dll || true && \
               echo \"üîÑ Restarting service...\" && \
               sudo systemctl daemon-reload && \
               sudo systemctl enable \$SERVICE_NAME && \
               sudo systemctl start \$SERVICE_NAME && \
               sudo rm -rf \$TEMP_DIR && \
               sudo rm -f /tmp/deployment-package.zip && \
               echo \"‚è≥ Waiting for service to initialize...\" && \
               sleep 5 && \
               if sudo systemctl is-active --quiet \$SERVICE_NAME; then \
                 echo \"‚úÖ Service started successfully!\" && \
                 sudo systemctl status \$SERVICE_NAME --no-pager -l; \
               else \
                 echo \"‚ùå Service failed to start. Showing logs:\" && \
                 sudo journalctl -u \$SERVICE_NAME --no-pager -n 50 && \
                 exit 1; \
               fi"
      
      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_rsa